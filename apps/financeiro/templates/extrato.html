{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>U-Balance - Extrato de Transa√ß√µes</title>
  <link rel="stylesheet" href="{% static 'extrato/css/extrato.css' %}" />
  <link rel="stylesheet" href="{% static 'core/css/style_dashboard.css' %}"/>

</head>
<body>
  <aside class="sidebar">
    <h1>U-Balance</h1>
    <nav>
      <a href="{% url 'core:dashboard' %}">üè† In√≠cio</a>
      <a href="#" id="abrirModalTransacao">üí≤ Adicionar Transa√ß√£o</a>
      <a href="#" id="abrirModalMeta">üéØ Adicionar Meta</a>
      <a href="#" id="abrirModalObjetivo">üìà Adicionar Objetivo</a>
      <a href="{% url 'core:metas:meta' %}">üéØ Metas</a>
      <a href="{% url 'core:objetivos:menu_objetivos' %}">üìà Objetivos</a>
      <a href="{% url 'core:menuExtrato' mes=mes ano=ano %}" class="active">üßæ Extrato</a>
      <a href="#">üìä Relat√≥rios</a>
      <a href="#">‚öôÔ∏è Configura√ß√µes</a>
      <a href="{% url 'usuario:logout' %}" id="logout">Logout</a>
    </nav>
  </aside>

  <main class="content">
    <div class="top-bar">
      <div>
        <h2 class="page-subtitle">Extrato de Transa√ß√µes</h2>
        <h1 class="page-title">Extrato de {{ mes_nome }}/{{ ano }}</h1>
      </div>
      <div class="user-info">
        <span>Usu√°rio: {{ user.first_name }} {{ user.last_name }}</span>
      </div>
    </div>

    <div class="summary-cards">
      <div class="summary-card balance">
        <h3>SALDO DO M√äS</h3>
        <p class="amount">R$ {{ saldo_mes|floatformat:2 }}</p>
      </div>
      <div class="summary-card income">
        <h3>RECEITAS DO M√äS</h3>
        <p class="amount">R$ {{ receitas_mes|floatformat:2 }}</p>
      </div>
      <div class="summary-card expense">
        <h3>DESPESAS DO M√äS</h3>
        <p class="amount">R$ {{ despesas_mes|floatformat:2 }}</p>
      </div>
    </div>

    <form method="POST" class="filters-section">
      {% csrf_token %}
      <div class="filters">
        <select name="mes" id="mes">
          <option value="janeiro">Janeiro</option>
          <option value="fevereiro">Fevereiro</option>
          <option value="marco">Mar√ßo</option>
          <option value="abril">Abril</option>
          <option value="maio" selected>Maio</option>
          <option value="junho">Junho</option>
          <option value="julho">Julho</option>
          <option value="agosto">Agosto</option>
          <option value="setembro">Setembro</option>
          <option value="outubro">Outubro</option>
          <option value="novembro">Novembro</option>
          <option value="dezembro">Dezembro</option>
        </select>

        <select name="ano" id="ano">
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
        </select>

        <select name="categoria" id="categoria">
          {% for categoria in categorias %}
            <option value="{{ categoria.nome }}">{{ categoria.nome }}</option>
          {% endfor %}
        </select>

        <select name="tipo" id="tipo">
          <option value="todos" selected>Todos os Tipos</option>
          <option value="receita">Receita</option>
          <option value="despesa">Despesa</option>
        </select>

        <button type="submit" class="filter-btn">Filtrar</button>
      </div>
    </form>

    <div class="transactions-table">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Categoria</th>
            <th>Descri√ß√£o</th>
            <th>Tipo</th>
            <th>Parcelas</th>
            <th>Valor (R$)</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for parcela in parcelas %}
          <tr>
            <td>{{ parcela.data|date:"d/m/Y" }}</td>
            <td>{{ parcela.transacao_fk.categoria_fk.nome }}</td>
            <td>{{ parcela.transacao_fk.descricao }}</td>
            <td>
              {% if parcela.transacao_fk.tipo == 'R' %}
                <span class="tipo-receita">Receita</span>
              {% else %}
                <span class="tipo-despesa">Despesa</span>
              {% endif %}
            </td>
            <td>
              {% if parcela.transacao_fk.quantidade_parcelas > 1 %}
                ({{ parcela.ordem_parcela }}/{{ parcela.transacao_fk.quantidade_parcelas }})
              {% else %}
                √Ä vista
              {% endif %}
            </td>
            <td class="{% if parcela.transacao_fk.tipo == 'R' %}valor-positivo{% else %}valor-negativo{% endif %}">
                {{ parcela.valor|floatformat:2 }}
            </td>
          <td style="display: flex; gap: 0.5rem;">
             {% if parcela.transacao_fk.quantidade_parcelas == 1 %}
             <a href="javascript:void(0)" class="btn-editar" onclick="editarTransacao('{{ parcela.id }}')">Editar</a>
             <button type="button" class="btn-excluir" onclick="deletarTransacao('{{ parcela.id }}')">Excluir</button>
              {% else %}
              <a href="javascript:void(0)" class="btn-editar" onclick="editarTransacaoParcela('{{ parcela.id }}')">Editar</a>
                 <button type="button" class="btn-excluir" onclick="deletarParcela('{{ parcela.id }}')">Excluir</button>
              {% endif %}
          </td>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </main>
  <div id="modalEditarTransacao" class="modal">
  <div class="modal-content">
    <h2>Editar Transa√ß√£o</h2>
    <form id="formEditarTransacao" method="POST">
      <label for="data">Data:</label>
      <input type="date" name="data" required>

      <label for="categoria">Categoria:</label>
      <input type="text" name="categoria" required>

      <label for="descricao">Descri√ß√£o:</label>
      <input type="text" name="descricao" required>

      <label for="tipo">Tipo:</label>
      <select name="tipo" required>
        <option value="receita">Receita</option>
        <option value="despesa">Despesa</option>
      </select>

      <label for="valor">Valor:</label>
      <input type="number" name="valor" step="0.01" required>

<div id="campo-pago" class="radio-group" style="display: none;">
  <label>Est√° pago?</label>
  <div class="radio-option">
    <input type="radio" name="pagamentoDespesa" id="pagamentoSIM">
    <label for="pagamentoSIM">Sim, j√° est√° pago.</label>
  </div>
  <div class="radio-option">
    <input type="radio" name="pagamentoDespesa" id="pagamentoNAO">
    <label for="pagamentoNAO">N√£o, n√£o est√° pago.</label>
  </div>
</div>

<div id="mensagem-receita" class="radio-group" style="display: none;">
  <label>J√° recebeu essa receita?</label>
  <div class="radio-option">
    <input type="radio" name="pagamentoReceita" id="recebidoSIM">
    <label for="recebidoSIM">Sim, j√° recebi.</label>
  </div>
  <div class="radio-option">
    <input type="radio" name="pagamentoReceita" id="recebidoNAO">
    <label for="recebidoNAO">N√£o, n√£o recebi ainda.</label>
  </div>
</div>


      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <div>
          <button type="submit" class="btn-salvar">Salvar</button>
          <button type="button" class="btn-cancelar" onclick="fecharModalHash()">Cancelar</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ESSE MODAL √â O DE EDITAR UMA PARCELA VOU ESCREVER O SIMBOLO "$" ONDE FICA AS DEPENDENCIAS DELE NO SCRIPT.-->
  <div id="modalEditarTransacaoParcela" class="modal">
  <div class="modal-content">
    <h2>Editar Transa√ß√£o</h2>
    <form id="formEditarTransacao">

	  <label for="valor">Valor:</label>
      <input type="number" name="valor" step="0.01" required>

      <label for="descricao">Descri√ß√£o:</label>
      <input type="text" name="descricao" required>

      <label for="tipo">Tipo:</label>
      <select name="tipo" required>
        <option value="receita">Receita</option>
        <option value="despesa">Despesa</option>
      </select>

<div id="campo-pago-parcela" class="radio-group" style="display: none;">
  <label>Est√° pago?</label>
  <div class="radio-option">
    <input type="radio" name="pagamentoDespesaParcela" id="pagamentoSIMParcela">
    <label for="pagamentoSIMParcela">Sim, j√° est√° pago.</label>
  </div>
  <div class="radio-option">
    <input type="radio" name="pagamentoDespesaParcela" id="pagamentoNAOParcela">
    <label for="pagamentoNAOParcela">N√£o, n√£o est√° pago.</label>
  </div>
</div>

<div id="mensagem-receita-parcela" class="radio-group" style="display: none;">
  <label>J√° recebeu essa receita?</label>
  <div class="radio-option">
    <input type="radio" name="pagamentoReceitaParcela" id="recebidoSIMParcela">
    <label for="recebidoSIMParcela">Sim, j√° recebi.</label>
  </div>
  <div class="radio-option">
    <input type="radio" name="pagamentoReceitaParcela" id="recebidoNAOParcela">
    <label for="recebidoNAOParcela">N√£o, n√£o recebi ainda.</label>
  </div>
</div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <div>
          <button type="submit" class="btn-salvar">Salvar</button>
          <button type="button" class="btn-cancelar" onclick="fecharModalHash()">Cancelar</button>
        </div>
      </div>
    </form>
  </div>
</div>
<div id="modalConfirmarExclusao" class="modal">
  <div class="modal-content">
    <h3>Tem certeza de que deseja excluir a transa√ß√£o?</h3>
    <div style="display: flex;  gap: 0.2rem; margin: 1rem 0;">
      <button class="btn-excluir" onClick="confirmarExclusao()" style="background-color: green;">Sim, desejo excluir.</button>
      <button class="btn-excluir" onclick="fecharModalExclusao()">N√£o, n√£o desejo excluir.</button>
	  <button class="btn-cancelar" onclick="fecharModalExclusao()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ${ -->
<div id="modalConfirmarExclusaoParcela" class="modal">
  <div class="modal-content">
    <h3>Como deseja excluir essa transa√ß√£o?</h3>
    <p>Escolha uma das op√ß√µes abaixo:</p>
    <div style="display: flex;  gap: 0.2rem; margin: 1rem 0;">
      <button class="btn-excluir" onclick="executarExclusao('unica')">Apenas esta parcela</button>
      <button class="btn-excluir" onclick="executarExclusao('futuras')">Esta e as pr√≥ximas</button>
      <button class="btn-excluir" onclick="executarExclusao('todas')">Todas as parcelas</button>
	  <button class="btn-cancelar" onclick="fecharModalExclusaoParcela()">Cancelar</button>
    </div>
  </div>
</div>
<!-- }$ -->



<div id="mensagem-receita-parcela" style="display: none; color: green; font-weight: bold;">
  Voc√™ j√° recebeu essa receita.
</div>

<div id="transacao_id" data-transacao-id="" hidden="hidden"></div>

<script>
    function editarTransacao(id) {
        location.hash = '#editar-transacao';
        document.getElementById("trasacao_id").dataset.transacaoId = id;
    }

    function editarTransacaoParcela(id) {
        location.hash = '#editar-parcela';
    }

    function deletarTransacao(id) {
        location.hash = '#deletar-transacao';
    }

    function deletarParcela(id) {
        location.hash = '#deletar-parcela';
    }

  function abrirModalViaHash() {
    fecharTodosModais();
    const hash = window.location.hash;
    if (hash === '#editar-transacao') {
      document.getElementById('modalEditarTransacao')?.classList.add('ativo');
    }
	if (hash === '#editar-parcela') {
      document.getElementById('modalEditarTransacaoParcela')?.classList.add('ativo');
    }
    if (hash === '#deletar-transacao') {
      document.getElementById('modalConfirmarExclusao')?.classList.add('ativo');
    }
    if (hash === '#deletar-parcela') {
      document.getElementById('modalConfirmarExclusaoParcela')?.classList.add('ativo');
    }
  }

  function fecharTodosModais() {
    document.querySelectorAll(".modal").forEach(modal => modal.classList.remove('ativo'));
    document.querySelectorAll(".modal-content").forEach(modal => modal.classList.remove('ativo'));
  }

  function fecharModalHash() {
    location.hash = '';
  }

  window.addEventListener('DOMContentLoaded', abrirModalViaHash);
  window.addEventListener('hashchange', abrirModalViaHash);

  document.getElementById("formEditarTransacao")?.addEventListener("submit", function(e) {
    e.preventDefault();
    const dados = new FormData(this);
    alert(`Transa√ß√£o atualizada:\nData: ${dados.get("data")}\nCategoria: ${dados.get("categoria")}\nDescri√ß√£o: ${dados.get("descricao")}\nTipo: ${dados.get("tipo")}\nParcelas: ${dados.get("parcelas") || '√Ä vista'}\nValor: R$ ${parseFloat(dados.get("valor")).toFixed(2)}`);
    fecharModalHash();
    this.reset();
  });
   document.addEventListener("DOMContentLoaded", () => {
       fecharTodosModais();
   });

function atualizarCampoPago() {
  const mensagemReceita = document.getElementById("mensagem-receita");
  const mensagemReceitaParcela = document.getElementById("mensagem-receita-parcela");
}

function fecharModalExclusao() {
  document.getElementById('modalConfirmarExclusao').classList.remove('ativo');
}

<!-- ${ -->

function fecharModalExclusaoParcela() {
  document.getElementById('modalConfirmarExclusaoParcela').classList.remove('ativo');
}

document.getElementById("formEditarTransacao").addEventListener("submit", function (event){
    event.preventDefault();
    const formData = new FormData(event.target);
    console.log(formData.keys());
});

</script>
</body>
</html>
